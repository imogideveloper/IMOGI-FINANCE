{#- Design & Template Setup -#}
{% if doc.receipt_design %}
  {% set design = frappe.get_doc("Receipt Design", doc.receipt_design) %}
{% else %}
  {% set design = get_default_receipt_design() %}
{% endif %}
{% set template = frappe.get_doc("Digital Stamp Template", doc.digital_stamp_template) if doc.digital_stamp_template else None %}
{% set stamp_image = doc.digital_stamp_image or (template.stamp_image if template else None) or design.digital_stamp_image %}
{% set verification_url = build_verification_url((template.verification_url_pattern if template else design.digital_stamp_url_pattern), doc.digital_stamp_reference) if doc.digital_stamp_reference else None %}
{% set company_logo = frappe.db.get_value("Company", doc.company, "company_logo") if doc.company else None %}
{% set receipt_logo = design.custom_logo if design.logo_mode == "Custom" and design.custom_logo else company_logo %}

<style>
  * {
    font-family: 'Segoe UI', 'Arial', sans-serif;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    background: #fff;
  }
  
  .cr-container { 
    width: 100%;
    max-width: 210mm;
    margin: 0 auto;
    padding: 12mm 15mm;
    font-size: 11pt;
    color: #000;
    position: relative;
    background: white;
    min-height: 297mm;
  }
  
  .cr-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20pt;
    padding-bottom: 15pt;
    border-bottom: 3pt double #000;
  }
  
  .cr-header-left {
    flex: 1;
    padding-right: 15pt;
  }
  
  .cr-header-right {
    flex: 1;
    text-align: right;
    padding-left: 15pt;
  }
  
  .cr-logo { 
    max-height: 70px; 
    max-width: 200px;
    margin-bottom: 12pt;
    display: block;
  }
  
  .cr-company { 
    font-size: 14pt; 
    font-weight: 700;
    color: #000;
    margin-bottom: 6pt;
    line-height: 1.3;
  }
  
  .cr-company-info {
    font-size: 9pt;
    color: #555;
    line-height: 1.7;
    margin-top: 4pt;
  }
  
  .cr-title {
    font-size: 24pt;
    font-weight: 800;
    letter-spacing: 4pt;
    color: #000;
    border: 3pt solid #000;
    padding: 10pt 20pt;
    display: inline-block;
    margin-bottom: 12pt;
  }
  
  .cr-meta { 
    font-size: 10pt; 
    color: #000;
    line-height: 2;
    font-weight: 500;
    margin-top: 8pt;
  }
  
  .cr-meta strong {
    font-weight: 700;
    display: inline-block;
    min-width: 60pt;
  }
  
  .cr-section {
    margin: 20pt 0;
  }
  
  .cr-section-title {
    font-size: 11pt;
    font-weight: 700;
    text-transform: uppercase;
    color: #000;
    margin-bottom: 15pt;
    padding-bottom: 6pt;
    border-bottom: 2pt solid #000;
    letter-spacing: 0.5pt;
  }
  
  .cr-info-grid {
    display: grid;
    grid-template-columns: 150pt 1fr;
    gap: 10pt 15pt;
    margin: 15pt 0;
    padding: 12pt 15pt;
    background: #fafafa;
    border-left: 4pt solid #000;
  }
  
  .cr-info-label {
    font-weight: 600;
    color: #000;
  }
  
  .cr-info-value {
    color: #000;
    line-height: 1.5;
  }
  
  .cr-amount-section {
    margin: 20pt 0;
    padding: 18pt 20pt;
    background: #f8f9fa;
    border: 3pt solid #000;
    border-radius: 0;
  }
  
  .cr-amount-label {
    font-size: 11pt;
    font-weight: 700;
    color: #333;
    margin-bottom: 12pt;
    text-transform: uppercase;
    letter-spacing: 1pt;
  }
  
  .cr-amount { 
    font-size: 28pt; 
    font-weight: 800;
    color: #000;
    margin-bottom: 15pt;
    letter-spacing: 1pt;
  }
  
  .cr-terbilang { 
    font-size: 10pt; 
    font-style: italic; 
    color: #000;
    line-height: 1.6;
    border-top: 2pt solid #ddd;
    padding-top: 12pt;
  }
  
  .cr-terbilang strong {
    font-style: normal;
    font-weight: 700;
  }
  
  .cr-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20pt 0;
    font-size: 10pt;
    border: 2pt solid #000;
  }
  
  .cr-table thead th {
    background: #000;
    color: white;
    padding: 12pt 15pt;
    text-align: left;
    font-weight: 700;
    border-bottom: 2pt solid #000;
    text-transform: uppercase;
    font-size: 9pt;
    letter-spacing: 0.5pt;
  }
  
  .cr-table thead th.right { 
    text-align: right; 
  }
  
  .cr-table tbody td {
    padding: 12pt 15pt;
    border-bottom: 1pt solid #ddd;
    vertical-align: top;
    line-height: 1.5;
  }
  
  .cr-table tbody td.right { 
    text-align: right;
    font-weight: 600;
  }
  
  .cr-table tbody tr:last-child td {
    border-bottom: 2pt solid #000;
  }
  
  .cr-table tfoot th {
    background: #f0f0f0;
    color: #000;
    padding: 15pt;
    font-weight: 700;
    border-top: 2pt solid #000;
  }
  
  .cr-table tfoot th.right {
    text-align: right;
    font-size: 13pt;
  }
  
  .cr-remarks {
    margin: 25pt 0;
    padding: 18pt 20pt;
    background: #f8f9fa;
    border-left: 4pt solid #000;
  }
  
  .cr-remarks-label {
    font-weight: 700;
    margin-bottom: 10pt;
    color: #000;
    font-size: 10pt;
    text-transform: uppercase;
  }
  
  .cr-remarks-text {
    color: #333;
    line-height: 1.7;
  }
  
  .cr-footer-section {
    margin-top: 30pt;
    display: flex;
    justify-content: space-between;
    gap: 20pt;
  }
  
  .cr-stamp-area {
    flex: 0 0 38%;
    text-align: center;
  }
  
  .cr-signature-area {
    flex: 0 0 38%;
    text-align: center;
  }
  
  .cr-stamp-box {
    border: 2pt dashed #999;
    text-align: center;
    font-size: 9pt;
    color: #999;
    padding: 10pt;
    min-height: 65mm;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fafafa;
    position: relative;
    font-weight: 500;
  }
  
  .cr-stamp-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  
  .cr-signature-box {
    min-height: 65mm;
    border-bottom: 2pt solid #000;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  
  .cr-sig-label {
    font-size: 10pt;
    color: #000;
    margin-bottom: 10pt;
    font-weight: 500;
  }
  
  .cr-sig-space {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .cr-sig-image {
    max-height: 50mm;
    max-width: 100%;
  }
  
  .cr-sig-info {
    padding-top: 10pt;
    text-align: center;
  }
  
  .cr-sig-name { 
    font-weight: 700; 
    font-size: 11pt;
    color: #000;
  }
  
  .cr-sig-role { 
    font-size: 9pt; 
    color: #666;
    margin-top: 3pt;
  }
  
  .cr-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-size: 52pt;
    color: rgba(220, 53, 69, 0.12);
    font-weight: 900;
    pointer-events: none;
    white-space: nowrap;
    z-index: 10;
    letter-spacing: 5pt;
  }
  
  .cr-print-info {
    margin-top: 40pt;
    padding-top: 15pt;
    border-top: 1pt solid #ccc;
    font-size: 8pt;
    color: #999;
    display: flex;
    justify-content: space-between;
    line-height: 1.5;
  }
  
  @media print {
    @page { 
      size: A4; 
      margin: 0;
    }
    
    body {
      margin: 0;
      padding: 0;
    }
    
    .cr-container {
      padding: 12mm 15mm;
    }
    
    .cr-table thead th { 
      background: #000 !important;
      color: white !important;
      -webkit-print-color-adjust: exact; 
      print-color-adjust: exact; 
    }
    
    .cr-amount-section,
    .cr-remarks,
    .cr-stamp-box,
    .cr-info-grid,
    .cr-table tfoot th {
      -webkit-print-color-adjust: exact; 
      print-color-adjust: exact;
    }
  }
</style>

<div class="cr-container">
  {% if doc.stamp_mode == "Digital" and doc.digital_stamp_status != "Issued" %}
    <div class="cr-watermark">MATERAI BELUM TERBIT</div>
  {% endif %}

  {#- Header -#}
  <div class="cr-header">
    <div class="cr-header-left">
      {% if receipt_logo %}
        <img class="cr-logo" src="{{ receipt_logo }}" alt="Logo">
      {% endif %}
      {% if doc.company %}
        <div class="cr-company">{{ doc.company }}</div>
        {% set company_address_name = frappe.db.get_value("Dynamic Link", {"link_doctype": "Company", "link_name": doc.company, "parenttype": "Address"}, "parent") %}
        {% if company_address_name %}
          {% set company_address = frappe.get_doc("Address", company_address_name) %}
          {% if company_address %}
          <div class="cr-company-info">
            {% if company_address.address_line1 %}{{ company_address.address_line1 }}{% endif %}
            {% if company_address.address_line2 %}, {{ company_address.address_line2 }}{% endif %}
            {% if company_address.city %}<br>{{ company_address.city }}{% endif %}
            {% if company_address.state %}, {{ company_address.state }}{% endif %}
          </div>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>
    <div class="cr-header-right">
      <div class="cr-title">{{ design.custom_wording_title or "KUITANSI" }}</div>
      <div class="cr-meta">
        <strong>No:</strong> {{ doc.name }}<br>
        <strong>Tanggal:</strong> {{ frappe.utils.formatdate(doc.posting_date, "dd MMMM yyyy") }}
      </div>
    </div>
  </div>

  {#- Customer Information Section -#}
  <div class="cr-section">
    <div class="cr-section-title">Informasi Penerima</div>
    <div class="cr-info-grid">
      <div class="cr-info-label">Diterima dari</div>
      <div class="cr-info-value">: {{ doc.customer }}</div>
      
      {% if doc.customer %}
        {% set customer_address_name = frappe.db.get_value("Dynamic Link", {"link_doctype": "Customer", "link_name": doc.customer, "parenttype": "Address"}, "parent") %}
        {% if customer_address_name %}
          {% set address_doc = frappe.get_doc("Address", customer_address_name) %}
          {% if address_doc %}
          <div class="cr-info-label">Alamat</div>
          <div class="cr-info-value">: 
            {% if address_doc.address_line1 %}{{ address_doc.address_line1 }}{% endif %}
            {% if address_doc.address_line2 %}, {{ address_doc.address_line2 }}{% endif %}
            {% if address_doc.city %}, {{ address_doc.city }}{% endif %}
            {% if address_doc.state %} - {{ address_doc.state }}{% endif %}
          </div>
          {% endif %}
        {% endif %}
      {% endif %}
      
      {% if doc.customer_reference_no %}
      <div class="cr-info-label">No. Referensi</div>
      <div class="cr-info-value">: {{ doc.customer_reference_no }}</div>
      {% endif %}
      
      {% if doc.branch %}
      <div class="cr-info-label">Cabang</div>
      <div class="cr-info-value">: {{ doc.branch }}</div>
      {% endif %}
    </div>
  </div>

  {#- Amount Section -#}
  <div class="cr-amount-section">
    <div class="cr-amount-label">Jumlah Uang</div>
    <div class="cr-amount">{{ frappe.utils.fmt_money(doc.total_amount, currency=doc.currency or 'IDR') }}</div>
    <div class="cr-terbilang">
      <strong>Terbilang:</strong> {{ terbilang_id(doc.total_amount) }}
    </div>
  </div>

  {#- Items Detail Table - Always show if items exist -#}
  {% if doc.items and doc.items|length > 0 %}
  <div class="cr-section">
    <div class="cr-section-title">Rincian Pembayaran</div>
    <table class="cr-table">
      <thead>
        <tr>
          <th style="width:8%">No</th>
          <th style="width:52%">Keterangan</th>
          <th class="right" style="width:40%">Jumlah</th>
        </tr>
      </thead>
      <tbody>
        {% for row in doc.items %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>
            {% if row.sales_invoice %}
              <strong>Invoice:</strong> {{ row.sales_invoice }}
            {% elif row.sales_order %}
              <strong>Sales Order:</strong> {{ row.sales_order }}
            {% elif row.reference_name %}
              {{ row.reference_name }}
            {% endif %}
            {% if row.description %}
              <br><small style="color: #666;">{{ row.description }}</small>
            {% endif %}
          </td>
          <td class="right">{{ frappe.utils.fmt_money(row.amount_to_collect or row.amount or 0, currency=doc.currency or 'IDR') }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="2" class="right">TOTAL</th>
          <th class="right">{{ frappe.utils.fmt_money(doc.total_amount, currency=doc.currency or 'IDR') }}</th>
        </tr>
      </tfoot>
    </table>
  </div>
  {% endif %}

  {#- Remarks -#}
  {% if doc.remarks %}
  <div class="cr-remarks">
    <div class="cr-remarks-label">Keterangan:</div>
    <div class="cr-remarks-text">{{ doc.remarks }}</div>
  </div>
  {% endif %}

  {#- Footer: Stamp and Signature -#}
  <div class="cr-footer-section">
    {#- Stamp Area -#}
    <div class="cr-stamp-area">
      {% if doc.stamp_mode and doc.stamp_mode != "None" %}
        {% set sw = design.stamp_width_mm or 35 %}
        {% set sh = design.stamp_height_mm or 40 %}
        <div style="margin-bottom: 8pt; font-weight: 600;">Materai</div>
        <div class="cr-stamp-box" style="width:{{ sw }}mm; height:{{ sh }}mm;">
          {% if doc.stamp_mode == "Physical" %}
            <div>Tempel<br>Materai<br>Di Sini</div>
          {% elif stamp_image %}
            <img src="{{ stamp_image }}" class="cr-stamp-image" style="opacity:{{ (design.digital_stamp_opacity_pct or 100)/100 }};">
          {% else %}
            <div>e-Materai<br>Belum<br>Diterbitkan</div>
          {% endif %}
        </div>
        {% if verification_url %}
          <div style="font-size: 7pt; margin-top: 4pt; color: #666;">
            Ref: {{ doc.digital_stamp_reference }}
          </div>
        {% endif %}
      {% endif %}
    </div>
    
    {#- Signature Area -#}
    <div class="cr-signature-area">
      <div class="cr-sig-label">
        {{ doc.company_location or doc.company or '' }}, {{ frappe.utils.formatdate(doc.posting_date, "dd MMMM yyyy") }}
      </div>
      <div class="cr-signature-box">
        <div class="cr-sig-space">
          {% if design.signature_image %}
            <img class="cr-sig-image" src="{{ design.signature_image }}" alt="Signature">
          {% endif %}
        </div>
        <div class="cr-sig-info">
          <div class="cr-sig-name">{{ design.signer_name or '( _________________ )' }}</div>
          {% if design.signer_role %}
            <div class="cr-sig-role">{{ design.signer_role }}</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {#- Print Info -#}
  <div class="cr-print-info">
    <div>Dicetak oleh: {{ frappe.session.user }} pada {{ frappe.utils.now_datetime().strftime("%d-%m-%Y %H:%M") }}</div>
    <div>IMOGI Finance - Customer Receipt</div>
  </div>
</div>
