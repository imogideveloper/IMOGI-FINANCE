{#- Design & Template Setup -#}
{% set design = frappe.get_doc("Receipt Design", doc.receipt_design) if doc.receipt_design else frappe._dict({
  "custom_wording_title": "KUITANSI",
  "show_detail_table": 1,
  "stamp_mode_default": "Physical",
  "stamp_position": "Bottom Right",
  "stamp_width_mm": 35,
  "stamp_height_mm": 40,
  "digital_stamp_opacity_pct": 100,
  "show_qr": 0,
  "custom_logo": None,
  "logo_mode": "Company Default"
}) %}
{% set template = frappe.get_doc("Digital Stamp Template", doc.digital_stamp_template) if doc.digital_stamp_template else None %}
{% set stamp_image = doc.digital_stamp_image or (template.stamp_image if template else None) or design.digital_stamp_image %}
{% set verification_url = build_verification_url((template.verification_url_pattern if template else design.digital_stamp_url_pattern), doc.digital_stamp_reference) if doc.digital_stamp_reference else None %}
{% set company_logo = frappe.db.get_value("Company", doc.company, "company_logo") if doc.company else None %}
{% set receipt_logo = design.custom_logo if design.logo_mode == "Custom" and design.custom_logo else company_logo %}

<style>
  * {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  .cr-container { 
    width: 100%;
    padding: 0;
    font-size: 10pt;
    color: #333;
    position: relative;
  }
  
  .cr-header {
    display: table;
    width: 100%;
    margin-bottom: 20pt;
  }
  
  .cr-header-left {
    display: table-cell;
    vertical-align: top;
    width: 50%;
  }
  
  .cr-header-right {
    display: table-cell;
    vertical-align: top;
    text-align: right;
    width: 50%;
  }
  
  .cr-logo { max-height: 45px; max-width: 120px; }
  .cr-company { font-size: 11pt; font-weight: 600; margin-top: 4pt; }
  
  .cr-title {
    font-size: 16pt;
    font-weight: 700;
    letter-spacing: 2pt;
    margin-bottom: 6pt;
  }
  
  .cr-meta { font-size: 9pt; color: #666; line-height: 1.5; }
  
  .cr-divider {
    border-top: 1pt solid #1a1a1a;
    margin: 15pt 0;
  }
  
  .cr-info {
    display: table;
    width: 100%;
    margin-bottom: 15pt;
  }
  
  .cr-info-row {
    display: table-row;
  }
  
  .cr-info-label {
    display: table-cell;
    width: 100pt;
    padding: 3pt 0;
    color: #666;
  }
  
  .cr-info-value {
    display: table-cell;
    padding: 3pt 0;
    font-weight: 500;
  }
  
  .cr-amount-box {
    background: #f5f5f5;
    padding: 12pt 15pt;
    margin: 15pt 0;
    text-align: center;
  }
  
  .cr-amount { font-size: 18pt; font-weight: 700; }
  .cr-terbilang { font-size: 9pt; font-style: italic; color: #555; margin-top: 4pt; }
  
  .cr-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15pt 0;
    font-size: 9pt;
  }
  
  .cr-table th {
    background: #1a1a1a;
    color: white;
    padding: 6pt 8pt;
    text-align: left;
    font-weight: 600;
  }
  
  .cr-table th.right { text-align: right; }
  
  .cr-table td {
    padding: 6pt 8pt;
    border-bottom: 1pt solid #ddd;
  }
  
  .cr-table td.right { text-align: right; }
  
  .cr-table tfoot th {
    background: #f5f5f5;
    color: #1a1a1a;
    border-top: 2pt solid #1a1a1a;
  }
  
  .cr-footer {
    margin-top: 30pt;
    text-align: right;
  }
  
  .cr-sign-stamp-box {
    display: inline-block;
    text-align: center;
    position: relative;
    min-width: 150pt;
  }
  
  .cr-stamp-box {
    border: 1pt dashed #999;
    text-align: center;
    font-size: 7pt;
    color: #888;
    padding: 4pt;
    margin: 0 auto;
  }
  
  .cr-sig-line {
    width: 100%;
    border-top: 1pt solid #333;
    margin-top: 8pt;
    padding-top: 4pt;
    text-align: center;
  }
  
  .cr-sig-name { font-weight: 600; font-size: 9pt; }
  .cr-sig-role { font-size: 8pt; color: #666; }
  
  .cr-sig-image {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1;
  }
  
  .cr-watermark {
    position: absolute;
    top: 35%;
    left: 15%;
    right: 15%;
    text-align: center;
    font-size: 16pt;
    color: rgba(200,0,0,0.2);
    transform: rotate(-20deg);
    font-weight: bold;
    pointer-events: none;
  }
  
  .cr-print-info {
    margin-top: 20pt;
    padding-top: 8pt;
    border-top: 1pt solid #eee;
    font-size: 7pt;
    color: #999;
    text-align: center;
  }
  
  @media print {
    @page { size: A4; margin: 15mm; }
    .cr-table th { background: #1a1a1a !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }
</style>

<div class="cr-container">
  {% if doc.stamp_mode == "Digital" and doc.digital_stamp_status != "Issued" %}
    <div class="cr-watermark">MATERAI BELUM TERBIT</div>
  {% endif %}

  {#- Header -#}
  <div class="cr-header">
    <div class="cr-header-left">
      {% if receipt_logo %}<img class="cr-logo" src="{{ receipt_logo }}">{% endif %}
      {% if doc.company %}<div class="cr-company">{{ doc.company }}</div>{% endif %}
    </div>
    <div class="cr-header-right">
      <div class="cr-title">{{ design.custom_wording_title or "KUITANSI" }}</div>
      <div class="cr-meta">
        No: {{ doc.name }}<br>
        Tanggal: {{ frappe.utils.formatdate(doc.posting_date) }}
      </div>
    </div>
  </div>

  <div class="cr-divider"></div>

  {#- Customer Info -#}
  <div class="cr-info">
    <div class="cr-info-row">
      <span class="cr-info-label">Diterima dari</span>
      <span class="cr-info-value">: {{ doc.customer }}</span>
    </div>
    {% if doc.customer_reference_no %}
    <div class="cr-info-row">
      <span class="cr-info-label">No. Referensi</span>
      <span class="cr-info-value">: {{ doc.customer_reference_no }}</span>
    </div>
    {% endif %}
  </div>

  {#- Amount -#}
  <div class="cr-amount-box">
    <div class="cr-amount">{{ frappe.utils.fmt_money(doc.total_amount, currency=doc.currency or 'IDR') }}</div>
    <div class="cr-terbilang">{{ terbilang_id(doc.total_amount) }}</div>
  </div>

  {#- Items Table -#}
  {% if design.show_detail_table and doc.items %}
  <table class="cr-table">
    <thead>
      <tr>
        <th style="width:5%">No</th>
        <th style="width:55%">Keterangan</th>
        <th class="right" style="width:40%">Jumlah</th>
      </tr>
    </thead>
    <tbody>
      {% for row in doc.items %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ row.sales_invoice or row.sales_order or row.reference_name or doc.remarks or '-' }}</td>
        <td class="right">{{ frappe.utils.fmt_money(row.amount_to_collect or row.amount or 0, currency=doc.currency or 'IDR') }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="2" class="right">Total</th>
        <th class="right">{{ frappe.utils.fmt_money(doc.total_amount, currency=doc.currency or 'IDR') }}</th>
      </tr>
    </tfoot>
  </table>
  {% endif %}

  {#- Footer: Signature over Stamp -#}
  <div class="cr-footer">
    <div class="cr-sign-stamp-box">
      {#- Signature image overlapping stamp -#}
      {% if design.signature_image %}
        <img class="cr-sig-image" src="{{ design.signature_image }}" style="max-height:45pt;">
      {% endif %}
      
      {#- Stamp area -#}
      {% if doc.stamp_mode and doc.stamp_mode != "None" %}
        {% set sw = design.stamp_width_mm or 35 %}
        {% set sh = design.stamp_height_mm or 40 %}
        <div class="cr-stamp-box" style="width:{{ sw }}mm;height:{{ sh }}mm;">
          {% if doc.stamp_mode == "Physical" %}
            <div style="margin-top:40%">Materai</div>
          {% elif stamp_image %}
            <img src="{{ stamp_image }}" style="width:100%;height:100%;object-fit:contain;opacity:{{ (design.digital_stamp_opacity_pct or 100)/100 }};">
          {% else %}
            <div style="margin-top:35%">e-Materai</div>
          {% endif %}
        </div>
      {% endif %}
      
      {#- Signature line -#}
      <div class="cr-sig-line">
        <div class="cr-sig-name">{{ design.signer_name or '' }}</div>
        {% if design.signer_role %}<div class="cr-sig-role">{{ design.signer_role }}</div>{% endif %}
      </div>
    </div>
  </div>

  <div class="cr-print-info">
    Dicetak: {{ frappe.utils.formatdate(frappe.utils.nowdate()) }} | IMOGI Finance
  </div>
</div>
