[
  {
    "doctype": "Client Script",
    "name": "Imogi Purchase Invoice Client Script",
    "dt": "Purchase Invoice",
    "view": "Form",
    "enabled": 1,
    "script": "frappe.ui.form.on('Purchase Invoice', {\n  refresh(frm) {\n    // Set filter for Expense Request dropdown\n    if (frm.fields_dict.imogi_expense_request) {\n      frm.set_query('imogi_expense_request', () => ({\n        filters: {\n          docstatus: 1,\n          status: ['in', ['Approved', 'PI Created']],\n        },\n      }));\n    }\n\n    // Fix: Force show tax fields (tax_category, taxes_and_charges)\n    // These fields are hidden by Frappe's guardian_has_value logic\n    // but are CRITICAL for PPN/PPh calculation from Expense Request\n    setTimeout(() => {\n      const taxFields = ['tax_category', 'taxes_and_charges'];\n      const taxesSection = frm.fields_dict.taxes_section;\n      \n      // Force show tax fields\n      taxFields.forEach(fieldname => {\n        const field = frm.fields_dict[fieldname];\n        if (field && field.wrapper) {\n          field.wrapper.removeClass('hide-control');\n          field.wrapper.show();\n        }\n      });\n      \n      // Force show taxes section\n      if (taxesSection && taxesSection.wrapper) {\n        taxesSection.wrapper.removeClass('empty-section');\n        taxesSection.wrapper.show();\n      }\n    }, 100);\n\n    // Show warning if PI is created manually (not from ER)\n    if (!frm.doc.imogi_expense_request && frm.doc.__islocal) {\n      frm.dashboard.set_headline_alert(\n        'Sebaiknya buat Purchase Invoice dari menu <b>Expense Request</b> untuk memastikan PPN/PPh ter-calculate dengan benar',\n        'orange'\n      );\n    }\n\n    // Show info if from ER\n    if (frm.doc.imogi_expense_request && !frm.doc.__islocal) {\n      frm.dashboard.set_headline_alert(\n        'Purchase Invoice dibuat dari Expense Request: ' + frm.doc.imogi_expense_request,\n        'blue'\n      );\n    }\n\n    // Add \"Create Payment Entry\" button if PI is from ER and submitted\n    if (frm.doc.imogi_expense_request && frm.doc.docstatus === 1 && !frm.doc.__islocal) {\n      frm.add_custom_button(__('Create Payment Entry'), async () => {\n        frappe.confirm(\n          __('Create Payment Entry for this Purchase Invoice from Expense Request {0}?', [frm.doc.imogi_expense_request]),\n          async () => {\n            try {\n              // Get ER data first\n              const er_data = await frappe.db.get_doc('Expense Request', frm.doc.imogi_expense_request);\n              \n              // Create Payment Entry using standard make_payment_entry\n              frappe.model.open_mapped_doc({\n                method: 'erpnext.accounts.doctype.purchase_invoice.purchase_invoice.make_payment_entry',\n                frm: frm,\n                args: {\n                  dt: frm.doc.doctype,\n                  dn: frm.doc.name\n                },\n                callback: function(pe) {\n                  // Set ER link and auto-fill remarks\n                  if (pe && er_data) {\n                    frappe.model.set_value(pe.doctype, pe.name, 'imogi_expense_request', frm.doc.imogi_expense_request);\n                    const remarks = 'Payment for Expense Request ' + er_data.name + ' - ' + (er_data.request_type || '');\n                    frappe.model.set_value(pe.doctype, pe.name, 'remarks', remarks);\n                  }\n                }\n              });\n            } catch (error) {\n              frappe.msgprint({\n                title: __('Error'),\n                message: error?.message || __('Failed to create Payment Entry'),\n                indicator: 'red',\n              });\n            }\n          }\n        );\n      }, __('Actions'));\n    }\n  },\n});\n"
  },
  {
    "doctype": "Client Script",
    "name": "Imogi Payment Entry Client Script",
    "dt": "Payment Entry",
    "view": "Form",
    "enabled": 1,
    "script": "frappe.ui.form.on('Payment Entry', {\n  refresh(frm) {\n    if (frm.fields_dict.imogi_expense_request) {\n      frm.set_query('imogi_expense_request', () => ({\n        filters: {\n          docstatus: 1,\n          status: ['in', ['PI Created']],\n        },\n      }));\n    }\n\n    // Validation: If PE is for PI linked to ER, must be created from PI button\n    if (frm.doc.__islocal && frm.doc.payment_type === 'Pay') {\n      // Check if references include PI with ER link\n      const references = frm.doc.references || [];\n      references.forEach(ref => {\n        if (ref.reference_doctype === 'Purchase Invoice' && ref.reference_name) {\n          frappe.db.get_value('Purchase Invoice', ref.reference_name, 'imogi_expense_request')\n            .then(r => {\n              if (r.message && r.message.imogi_expense_request) {\n                frm.dashboard.set_headline_alert(\n                  '<b>Perhatian:</b> Purchase Invoice ini terkait dengan Expense Request. Sebaiknya buat Payment Entry dari button \"Create Payment Entry\" di Purchase Invoice untuk flow yang benar.',\n                  'orange'\n                );\n              }\n            });\n        }\n      });\n    }\n  },\n  imogi_expense_request(frm) {\n    if (!frm.doc.imogi_expense_request) {\n      return;\n    }\n    frappe.call({\n      method: 'frappe.client.get',\n      args: {\n        doctype: 'Expense Request',\n        name: frm.doc.imogi_expense_request,\n      },\n      callback(r) {\n        if (r.message) {\n          const er = r.message;\n          if (er.total_amount) {\n            frm.set_value('paid_amount', er.total_amount);\n            frm.set_value('received_amount', er.total_amount);\n          }\n          if (!frm.doc.remarks || !frm.doc.remarks.includes('Expense Request')) {\n            const remarks = 'Payment for Expense Request ' + er.name + ' - ' + (er.request_type || '');\n            frm.set_value('remarks', remarks);\n          }\n        }\n      },\n    });\n  },\n});\n"
  }
]
